#include <WiFi.h>

// ---- WiFi ----
const char* ssid     = "TA3KRT";
const char* password = "?sngMuDvk@#";

// ---- Sabit IP ----
IPAddress local_IP(192, 168, 0, 20);
IPAddress gateway(192, 168, 0, 1);
IPAddress subnet(255, 255, 255, 0);

// ---- Pinler ----
#define RELAY_PIN 5
#define LED_PIN   4   // D4 LED

WiFiServer server(80);

// ---- Ayarlar ----
int heatTimeMin = 40;           // Varsayilan: 40 dakika
unsigned long heatStartTime = 0;
bool roleDurum = false;

// ---- LED WiFi blink ----
unsigned long previousBlink = 0;
bool ledState = false;
const int blinkInterval = 350; // ms

// Sureyi guzel gosterme
String formatTime(unsigned long ms) {
  unsigned long totalSec = ms / 1000;
  int min = totalSec / 60;
  int sec = totalSec % 60;

  char buffer[16];
  sprintf(buffer, "%02d:%02d", min, sec);
  return String(buffer);
}

void setup() {
  Serial.begin(115200);
  delay(300);

  pinMode(RELAY_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);

  digitalWrite(RELAY_PIN, LOW);
  digitalWrite(LED_PIN, LOW);

  WiFi.config(local_IP, gateway, subnet);
  WiFi.begin(ssid, password);

  Serial.print("WiFi baglaniyor...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\nBaglandi!");
  Serial.print("IP Adres: ");
  Serial.println(WiFi.localIP());

  server.begin();
}

void loop() {

  // ---- WiFi kontrol ----
  if (WiFi.status() != WL_CONNECTED) {
    unsigned long currentMillis = millis();
    if (currentMillis - previousBlink >= blinkInterval) {
      previousBlink = currentMillis;
      ledState = !ledState;
      digitalWrite(LED_PIN, ledState ? HIGH : LOW);
    }
  }

  // ---- ZAMAN KONTROLU ----
  if (roleDurum && WiFi.status() == WL_CONNECTED) {
    digitalWrite(LED_PIN, HIGH); // Röle açık -> LED sabit yanar

    unsigned long elapsed = millis() - heatStartTime;
    unsigned long total = (unsigned long)heatTimeMin * 60UL * 1000UL;

    if (elapsed >= total) {
      digitalWrite(RELAY_PIN, LOW);
      digitalWrite(LED_PIN, LOW);
      roleDurum = false;
      Serial.println("Sure doldu -> Role kapatildi!");
    }
  }

  // ---- HTTP ----
  if (WiFi.status() == WL_CONNECTED) {
    WiFiClient client = server.available();
    if (!client) return;

    String req = client.readStringUntil('\r');
    client.flush();

    if (req.indexOf("/on") != -1) {
      digitalWrite(RELAY_PIN, HIGH);
      digitalWrite(LED_PIN, HIGH);    // LED yanıyor
      roleDurum = true;
      heatStartTime = millis();
      Serial.println("Role ACIK (Sayac basladi)");
    }

    if (req.indexOf("/off") != -1) {
      digitalWrite(RELAY_PIN, LOW);
      digitalWrite(LED_PIN, LOW);     // LED sönüyor
      roleDurum = false;
      Serial.println("Role KAPALI (Sayac sifirlandi)");
    }

    if (req.indexOf("/set?time=") != -1) {
      int idx = req.indexOf("time=") + 5;
      heatTimeMin = req.substring(idx).toInt();
      if (heatTimeMin < 1) heatTimeMin = 1;
      if (heatTimeMin > 240) heatTimeMin = 240;
      Serial.print("Yeni sure: ");
      Serial.println(heatTimeMin);
    }

    // ---- HTML ----
    client.println("HTTP/1.1 200 OK");
    client.println("Content-Type: text/html\n");
    client.println("<html><head>");

    client.println("<style>");
    client.println("body { text-align:center; font-family:Arial; margin-top:100px; }");
    client.println("h1 { font-size:60px; margin-bottom:60px; }");
    client.println("button { width:250px; height:100px; font-size:40px; margin:30px; border-radius:25px; color:white; border:none; }");
    client.println(".durum { font-size:36px; margin-top:40px; font-weight:bold; }");
    client.println("input { font-size:32px; padding:10px; width:150px; text-align:center; margin-top:20px; }");
    client.println(".progress-container { width:80%; background-color:#ddd; margin:20px auto; height:40px; border-radius:20px; }");
    client.println(".progress-bar { width:100%; height:100%; background-color:green; border-radius:20px; }");
    client.println("</style>");

    // JavaScript ile kalan süre, buton renkleri ve progress bar
    client.println("<script>");
    client.println("var roleDurum = " + String(roleDurum ? "true" : "false") + ";");
    client.println("var totalMs = " + String(roleDurum ? ((unsigned long)heatTimeMin * 60UL * 1000UL - (millis() - heatStartTime)) : 0) + ";");
    client.println("var totalTimeMs = " + String((unsigned long)heatTimeMin*60UL*1000UL) + ";");

    client.println("function updateTime(){");
    client.println("  if(roleDurum){");
    client.println("    if(totalMs <= 0){ document.getElementById('kalan').innerHTML='00:00'; roleDurum=false; updateButtons(); updateProgress(); return; }");
    client.println("    var sec = Math.floor(totalMs/1000)%60;");
    client.println("    var min = Math.floor(totalMs/1000/60);");
    client.println("    document.getElementById('kalan').innerHTML = ('0'+min).slice(-2)+':'+('0'+sec).slice(-2);");
    client.println("    totalMs -= 1000;");
    client.println("  } else { document.getElementById('kalan').innerHTML='00:00'; }");
    client.println("  updateButtons();");
    client.println("  updateProgress();");
    client.println("}");

    client.println("function updateButtons(){");
    client.println("  if(roleDurum){");
    client.println("    document.getElementById('acButton').style.backgroundColor='green';");
    client.println("    document.getElementById('kapatButton').style.backgroundColor='gray';");
    client.println("  } else {");
    client.println("    document.getElementById('acButton').style.backgroundColor='gray';");
    client.println("    document.getElementById('kapatButton').style.backgroundColor='red';");
    client.println("  }");
    client.println("}");

    // Kalan süreye göre soldan sağa azalan progress bar
    client.println("function updateProgress(){");
    client.println("  var bar = document.getElementById('progress');");
    client.println("  if(roleDurum){");
    client.println("    var remainingPercent = (totalMs / totalTimeMs) * 100;");
    client.println("    bar.style.width = remainingPercent + '%';");
    client.println("  } else { bar.style.width = '0%'; }");
    client.println("}");

    client.println("setInterval(updateTime,1000);");
    client.println("</script>");

    client.println("</head><body>");
    client.println("<h1>ESP32 Kombi Kontrol</h1>");

    client.println("<a href='/on'><button id='acButton'>AC</button></a>");
    client.println("<a href='/off'><button id='kapatButton'>KAPAT</button></a>");

    client.print("<div class='durum'>Role: ");
    client.print(roleDurum ? "ACIK" : "KAPALI");
    client.println("</div>");

    client.print("<div class='durum'>Isinma Sure (dk): ");
    client.print(heatTimeMin);
    client.println("</div>");

    client.println("<form action='/set'>"
                   "<input type='number' name='time' min='1' max='240'>"
                   "<button type='submit'>Kaydet</button>"
                   "</form>");

    client.println("<div class='durum'>Kalan Sure: <span id='kalan'>" + (roleDurum ? formatTime((unsigned long)heatTimeMin*60UL*1000UL - (millis()-heatStartTime)) : "00:00") + "</span></div>");

    // Progress bar
    client.println("<div class='progress-container'><div id='progress' class='progress-bar'></div></div>");

    client.stop();
  }
}
